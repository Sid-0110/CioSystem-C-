# è³‡æ–™å­˜å–å±¤å­¸ç¿’æŒ‡å—

## ğŸ¯ å­¸ç¿’ç›®æ¨™

æœ¬æŒ‡å—å°‡å¸¶é ˜æ‚¨å­¸ç¿’å¦‚ä½•å¯¦ä½œç¾ä»£ C# æ‡‰ç”¨ç¨‹å¼çš„è³‡æ–™å­˜å–å±¤ï¼ŒåŒ…æ‹¬ Entity Framework Coreã€Repository æ¨¡å¼å’Œ Unit of Work æ¨¡å¼çš„å¯¦ä½œã€‚

## ğŸ“š å·²å®Œæˆçš„æ ¸å¿ƒçµ„ä»¶

### 1. Entity Framework Core è¨­å®š âœ…

#### CioSystemDbContext.cs
- **ä½ç½®**: `CioSystem.Data/CioSystemDbContext.cs`
- **åŠŸèƒ½**: 
  - å®šç¾©è³‡æ–™åº«æ¨¡å‹å’Œé—œä¿‚
  - é…ç½®å¯¦é«”ç´„æŸå’Œç´¢å¼•
  - å¯¦ä½œè»Ÿåˆªé™¤éæ¿¾å™¨
  - è‡ªå‹•æ›´æ–°å¯©è¨ˆæ¬„ä½

#### ä¸»è¦ç‰¹è‰²ï¼š
```csharp
// è»Ÿåˆªé™¤éæ¿¾å™¨
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // ç‚ºæ‰€æœ‰ç¹¼æ‰¿ BaseEntity çš„å¯¦é«”è¨­å®šè»Ÿåˆªé™¤éæ¿¾å™¨
    foreach (var entityType in modelBuilder.Model.GetEntityTypes())
    {
        if (typeof(CioSystem.Core.BaseEntity).IsAssignableFrom(entityType.ClrType))
        {
            // è‡ªå‹•éæ¿¾å·²åˆªé™¤çš„è¨˜éŒ„
        }
    }
}

// è‡ªå‹•æ›´æ–°å¯©è¨ˆæ¬„ä½
public override async Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
{
    UpdateAuditFields(); // è‡ªå‹•è¨­å®š CreatedAt å’Œ UpdatedAt
    return await base.SaveChangesAsync(cancellationToken);
}
```

### 2. Repository æ¨¡å¼å¯¦ä½œ âœ…

#### Repository.cs
- **ä½ç½®**: `CioSystem.Data/Repositories/Repository.cs`
- **åŠŸèƒ½**:
  - æ³›å‹ CRUD æ“ä½œ
  - åˆ†é æŸ¥è©¢
  - æ¢ä»¶æŸ¥è©¢
  - æ‰¹æ¬¡æ“ä½œ

#### æ ¸å¿ƒæ–¹æ³•ï¼š
```csharp
public class Repository<T> : IRepository<T> where T : BaseEntity
{
    // åŸºæœ¬ CRUD æ“ä½œ
    public virtual async Task<T?> GetByIdAsync(int id)
    public virtual async Task<IEnumerable<T>> GetAllAsync()
    public virtual async Task<T> AddAsync(T entity)
    public virtual async Task<T> UpdateAsync(T entity)
    public virtual async Task<bool> DeleteAsync(int id) // è»Ÿåˆªé™¤
    
    // é€²éšæŸ¥è©¢
    public virtual async Task<(IEnumerable<T> Items, int TotalCount)> GetPagedAsync(...)
    public virtual async Task<IEnumerable<T>> FindAsync(Expression<Func<T, bool>> predicate)
    public virtual IQueryable<T> GetQueryableWithIncludes(...)
}
```

### 3. Unit of Work æ¨¡å¼å¯¦ä½œ âœ…

#### UnitOfWork.cs
- **ä½ç½®**: `CioSystem.Data/UnitOfWork.cs`
- **åŠŸèƒ½**:
  - ç®¡ç†è³‡æ–™åº«äº¤æ˜“
  - å”èª¿å¤šå€‹å„²å­˜åº«
  - æ‰¹æ¬¡æ“ä½œç®¡ç†
  - è®Šæ›´è¿½è¹¤

#### æ ¸å¿ƒåŠŸèƒ½ï¼š
```csharp
public class UnitOfWork : IUnitOfWork
{
    // äº¤æ˜“ç®¡ç†
    public async Task BeginTransactionAsync()
    public async Task CommitTransactionAsync()
    public async Task RollbackTransactionAsync()
    public async Task<T> ExecuteInTransactionAsync<T>(Func<Task<T>> action)
    
    // å„²å­˜åº«ç®¡ç†
    public IRepository<T> GetRepository<T>() where T : BaseEntity
    public IRepository<Product> Products { get; }
    public IRepository<Inventory> Inventory { get; }
    
    // æ‰¹æ¬¡æ“ä½œ
    public async Task<int> BatchOperationAsync<T>(IEnumerable<T> entities, BatchOperation operation)
}
```

### 4. ä¾è³´æ³¨å…¥é…ç½® âœ…

#### ServiceCollectionExtensions.cs
- **ä½ç½®**: `CioSystem.Data/DependencyInjection/ServiceCollectionExtensions.cs`
- **åŠŸèƒ½**:
  - è³‡æ–™åº«é€£æ¥é…ç½®
  - æœå‹™è¨»å†Š
  - ç¨®å­è³‡æ–™

#### æ”¯æ´çš„è³‡æ–™åº«ï¼š
```csharp
// SQLiteï¼ˆé è¨­ï¼Œé©åˆå­¸ç¿’ï¼‰
services.AddDataLayer(configuration);

// SQL Server
services.AddSqlServerDataLayer(configuration);

// PostgreSQLï¼ˆéœ€è¦é¡å¤–å¥—ä»¶ï¼‰
services.AddPostgreSqlDataLayer(configuration);

// è¨˜æ†¶é«”è³‡æ–™åº«ï¼ˆæ¸¬è©¦ç”¨ï¼‰
services.AddInMemoryDataLayer();
```

## ğŸš€ ä¸‹ä¸€æ­¥å­¸ç¿’å»ºè­°

### éšæ®µä¸€ï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µ

1. **ç ”ç©¶ DbContext è¨­è¨ˆ**
   ```csharp
   // æŸ¥çœ‹ CioSystemDbContext.cs ä¸­çš„ï¼š
   // - å¯¦é«”é…ç½®æ–¹æ³•
   // - é—œä¿‚è¨­å®š
   // - ç´¢å¼•é…ç½®
   // - è»Ÿåˆªé™¤éæ¿¾å™¨
   ```

2. **ç†è§£ Repository æ¨¡å¼**
   ```csharp
   // å­¸ç¿’ Repository.cs ä¸­çš„ï¼š
   // - æ³›å‹è¨­è¨ˆ
   // - éåŒæ­¥æ“ä½œ
   // - åˆ†é æŸ¥è©¢
   // - æ¢ä»¶æŸ¥è©¢
   ```

3. **æŒæ¡ Unit of Work æ¨¡å¼**
   ```csharp
   // ç ”ç©¶ UnitOfWork.cs ä¸­çš„ï¼š
   // - äº¤æ˜“ç®¡ç†
   // - å„²å­˜åº«å”èª¿
   // - æ‰¹æ¬¡æ“ä½œ
   // - éŒ¯èª¤è™•ç†
   ```

### éšæ®µäºŒï¼šå¯¦ä½œæ¥­å‹™é‚è¼¯å±¤

1. **å‰µå»ºæœå‹™ä»‹é¢**
   ```csharp
   // åœ¨ CioSystem.Services ä¸­å‰µå»ºï¼š
   // - IProductService.cs
   // - IInventoryService.cs
   ```

2. **å¯¦ä½œæœå‹™é¡åˆ¥**
   ```csharp
   // å¯¦ä½œï¼š
   // - ProductService.cs
   // - InventoryService.cs
   ```

3. **æ·»åŠ æ¥­å‹™é‚è¼¯é©—è­‰**
   ```csharp
   // å¯¦ä½œï¼š
   // - è³‡æ–™é©—è­‰
   // - æ¥­å‹™è¦å‰‡æª¢æŸ¥
   // - ç•°å¸¸è™•ç†
   ```

### éšæ®µä¸‰ï¼šå»ºç«‹ API å±¤

1. **å‰µå»º DTO é¡åˆ¥**
   ```csharp
   // åœ¨ CioSystem.API/DTOs ä¸­å‰µå»ºï¼š
   // - ProductDto.cs
   // - CreateProductDto.cs
   // - UpdateProductDto.cs
   ```

2. **å¯¦ä½œ API æ§åˆ¶å™¨**
   ```csharp
   // åœ¨ CioSystem.API/Controllers ä¸­å‰µå»ºï¼š
   // - ProductsController.cs
   // - InventoryController.cs
   ```

3. **é…ç½®ä¾è³´æ³¨å…¥**
   ```csharp
   // åœ¨ Program.cs ä¸­ï¼š
   services.AddDataLayer(configuration);
   services.AddScoped<IProductService, ProductService>();
   ```

## ğŸ› ï¸ å¯¦ç”¨å·¥å…·å’ŒæŒ‡ä»¤

### Entity Framework æŒ‡ä»¤
```bash
# å®‰è£ EF Core å·¥å…·
dotnet tool install --global dotnet-ef

# æ–°å¢é·ç§»
dotnet ef migrations add InitialCreate --project CioSystem.Data

# æ›´æ–°è³‡æ–™åº«
dotnet ef database update --project CioSystem.Data

# ç§»é™¤æœ€å¾Œä¸€å€‹é·ç§»
dotnet ef migrations remove --project CioSystem.Data
```

### æ¸¬è©¦æŒ‡ä»¤
```bash
# å»ºç½®å°ˆæ¡ˆ
dotnet build

# åŸ·è¡Œæ¸¬è©¦
dotnet test

# åŸ·è¡Œ API å°ˆæ¡ˆ
dotnet run --project CioSystem.API
```

## ğŸ“– å­¸ç¿’é‡é»

### 1. è³‡æ–™åº«è¨­è¨ˆåŸå‰‡
- **æ­£è¦åŒ–**: é¿å…è³‡æ–™å†—é¤˜
- **ç´¢å¼•**: æé«˜æŸ¥è©¢æ•ˆèƒ½
- **ç´„æŸ**: ç¢ºä¿è³‡æ–™å®Œæ•´æ€§
- **é—œä¿‚**: æ­£ç¢ºè¨­å®šå¤–éµé—œä¿‚

### 2. Repository æ¨¡å¼å„ªé»
- **æŠ½è±¡åŒ–**: éš±è—è³‡æ–™å­˜å–ç´°ç¯€
- **å¯æ¸¬è©¦æ€§**: ä¾¿æ–¼å–®å…ƒæ¸¬è©¦
- **ä¸€è‡´æ€§**: çµ±ä¸€çš„è³‡æ–™å­˜å–ä»‹é¢
- **å½ˆæ€§**: æ”¯æ´ä¸åŒçš„è³‡æ–™ä¾†æº

### 3. Unit of Work æ¨¡å¼å„ªé»
- **äº¤æ˜“ç®¡ç†**: ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
- **æ•ˆèƒ½å„ªåŒ–**: æ‰¹æ¬¡æ“ä½œ
- **éŒ¯èª¤è™•ç†**: çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- **è³‡æºç®¡ç†**: è‡ªå‹•é‡‹æ”¾è³‡æº

### 4. æœ€ä½³å¯¦è¸
- **éåŒæ­¥æ“ä½œ**: ä½¿ç”¨ async/await
- **è»Ÿåˆªé™¤**: ä¿ç•™è³‡æ–™æ­·å²
- **å¯©è¨ˆè¿½è¹¤**: è¨˜éŒ„å»ºç«‹å’Œä¿®æ”¹æ™‚é–“
- **éŒ¯èª¤è™•ç†**: é©ç•¶çš„ç•°å¸¸è™•ç†

## ğŸ“ å­¸ç¿’æª¢æŸ¥æ¸…å–®

### åŸºç¤æ¦‚å¿µ
- [ ] ç†è§£ Entity Framework Core çš„å·¥ä½œåŸç†
- [ ] æŒæ¡ DbContext çš„é…ç½®æ–¹æ³•
- [ ] äº†è§£å¯¦é«”é—œä¿‚çš„è¨­å®š
- [ ] å­¸æœƒä½¿ç”¨é·ç§»ç®¡ç†è³‡æ–™åº«çµæ§‹

### Repository æ¨¡å¼
- [ ] ç†è§£ Repository æ¨¡å¼çš„å„ªé»
- [ ] æŒæ¡æ³›å‹ Repository çš„è¨­è¨ˆ
- [ ] å­¸æœƒå¯¦ä½œåˆ†é æŸ¥è©¢
- [ ] äº†è§£æ¢ä»¶æŸ¥è©¢çš„ä½¿ç”¨

### Unit of Work æ¨¡å¼
- [ ] ç†è§£ Unit of Work çš„ä½œç”¨
- [ ] æŒæ¡äº¤æ˜“ç®¡ç†çš„æ–¹æ³•
- [ ] å­¸æœƒæ‰¹æ¬¡æ“ä½œçš„å¯¦ä½œ
- [ ] äº†è§£éŒ¯èª¤è™•ç†ç­–ç•¥

### å¯¦ä½œæŠ€èƒ½
- [ ] èƒ½å¤ å»ºç«‹æ–°çš„å¯¦é«”æ¨¡å‹
- [ ] èƒ½å¤ é…ç½®å¯¦é«”é—œä¿‚
- [ ] èƒ½å¤ å¯¦ä½œæ–°çš„ Repository
- [ ] èƒ½å¤ ä½¿ç”¨ Unit of Work ç®¡ç†äº¤æ˜“

## ğŸ”§ å¸¸è¦‹å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ

### Q: å¦‚ä½•æ–°å¢æ–°çš„å¯¦é«”ï¼Ÿ
A: 
1. åœ¨ `CioSystem.Models` ä¸­å‰µå»ºå¯¦é«”é¡åˆ¥
2. ç¹¼æ‰¿ `BaseEntity`
3. åœ¨ `CioSystemDbContext` ä¸­æ·»åŠ  `DbSet`
4. åœ¨ `OnModelCreating` ä¸­é…ç½®å¯¦é«”

### Q: å¦‚ä½•å¯¦ä½œæ–°çš„ Repositoryï¼Ÿ
A:
1. å¯¦ä½œ `IRepository<T>` ä»‹é¢
2. ç¹¼æ‰¿ `Repository<T>` åŸºç¤é¡åˆ¥
3. æ·»åŠ ç‰¹å®šçš„æ¥­å‹™æ–¹æ³•
4. åœ¨ `UnitOfWork` ä¸­è¨»å†Š

### Q: å¦‚ä½•è™•ç†è¤‡é›œæŸ¥è©¢ï¼Ÿ
A:
1. ä½¿ç”¨ `IQueryable` å»ºç«‹æŸ¥è©¢
2. ä½¿ç”¨ `Include` è¼‰å…¥ç›¸é—œè³‡æ–™
3. ä½¿ç”¨ `Where` æ·»åŠ æ¢ä»¶
4. ä½¿ç”¨ `OrderBy` æ’åºçµæœ

### Q: å¦‚ä½•å„ªåŒ–æŸ¥è©¢æ•ˆèƒ½ï¼Ÿ
A:
1. ä½¿ç”¨é©ç•¶çš„ç´¢å¼•
2. é¿å… N+1 æŸ¥è©¢å•é¡Œ
3. ä½¿ç”¨åˆ†é æŸ¥è©¢
4. å¿«å–å¸¸ç”¨è³‡æ–™

## ğŸš€ ä¸‹ä¸€æ­¥

ç¾åœ¨æ‚¨å·²ç¶“å®Œæˆäº†è³‡æ–™å­˜å–å±¤çš„å¯¦ä½œï¼æ¥ä¸‹ä¾†å¯ä»¥ï¼š

1. **å¯¦ä½œæ¥­å‹™é‚è¼¯å±¤**: å‰µå»ºæœå‹™é¡åˆ¥å’Œæ¥­å‹™é‚è¼¯
2. **å»ºç«‹ API å±¤**: å¯¦ä½œ RESTful API ç«¯é»
3. **é–‹ç™¼ Web ä»‹é¢**: å‰µå»ºä½¿ç”¨è€…ä»‹é¢
4. **æ·»åŠ æ¸¬è©¦**: æ’°å¯«å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦

è¨˜ä½ï¼šå­¸ç¿’è³‡æ–™å­˜å–å±¤æ˜¯å»ºç«‹ç¾ä»£æ‡‰ç”¨ç¨‹å¼çš„åŸºç¤ï¼ŒæŒæ¡é€™äº›æ¦‚å¿µå°‡ç‚ºæ‚¨çš„å¾ŒçºŒå­¸ç¿’æ‰“ä¸‹å …å¯¦çš„åŸºç¤ï¼