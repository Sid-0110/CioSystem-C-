# 資料存取層學習指南

## 🎯 學習目標

本指南將帶領您學習如何實作現代 C# 應用程式的資料存取層，包括 Entity Framework Core、Repository 模式和 Unit of Work 模式的實作。

## 📚 已完成的核心組件

### 1. Entity Framework Core 設定 ✅

#### CioSystemDbContext.cs
- **位置**: `CioSystem.Data/CioSystemDbContext.cs`
- **功能**: 
  - 定義資料庫模型和關係
  - 配置實體約束和索引
  - 實作軟刪除過濾器
  - 自動更新審計欄位

#### 主要特色：
```csharp
// 軟刪除過濾器
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // 為所有繼承 BaseEntity 的實體設定軟刪除過濾器
    foreach (var entityType in modelBuilder.Model.GetEntityTypes())
    {
        if (typeof(CioSystem.Core.BaseEntity).IsAssignableFrom(entityType.ClrType))
        {
            // 自動過濾已刪除的記錄
        }
    }
}

// 自動更新審計欄位
public override async Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
{
    UpdateAuditFields(); // 自動設定 CreatedAt 和 UpdatedAt
    return await base.SaveChangesAsync(cancellationToken);
}
```

### 2. Repository 模式實作 ✅

#### Repository.cs
- **位置**: `CioSystem.Data/Repositories/Repository.cs`
- **功能**:
  - 泛型 CRUD 操作
  - 分頁查詢
  - 條件查詢
  - 批次操作

#### 核心方法：
```csharp
public class Repository<T> : IRepository<T> where T : BaseEntity
{
    // 基本 CRUD 操作
    public virtual async Task<T?> GetByIdAsync(int id)
    public virtual async Task<IEnumerable<T>> GetAllAsync()
    public virtual async Task<T> AddAsync(T entity)
    public virtual async Task<T> UpdateAsync(T entity)
    public virtual async Task<bool> DeleteAsync(int id) // 軟刪除
    
    // 進階查詢
    public virtual async Task<(IEnumerable<T> Items, int TotalCount)> GetPagedAsync(...)
    public virtual async Task<IEnumerable<T>> FindAsync(Expression<Func<T, bool>> predicate)
    public virtual IQueryable<T> GetQueryableWithIncludes(...)
}
```

### 3. Unit of Work 模式實作 ✅

#### UnitOfWork.cs
- **位置**: `CioSystem.Data/UnitOfWork.cs`
- **功能**:
  - 管理資料庫交易
  - 協調多個儲存庫
  - 批次操作管理
  - 變更追蹤

#### 核心功能：
```csharp
public class UnitOfWork : IUnitOfWork
{
    // 交易管理
    public async Task BeginTransactionAsync()
    public async Task CommitTransactionAsync()
    public async Task RollbackTransactionAsync()
    public async Task<T> ExecuteInTransactionAsync<T>(Func<Task<T>> action)
    
    // 儲存庫管理
    public IRepository<T> GetRepository<T>() where T : BaseEntity
    public IRepository<Product> Products { get; }
    public IRepository<Inventory> Inventory { get; }
    
    // 批次操作
    public async Task<int> BatchOperationAsync<T>(IEnumerable<T> entities, BatchOperation operation)
}
```

### 4. 依賴注入配置 ✅

#### ServiceCollectionExtensions.cs
- **位置**: `CioSystem.Data/DependencyInjection/ServiceCollectionExtensions.cs`
- **功能**:
  - 資料庫連接配置
  - 服務註冊
  - 種子資料

#### 支援的資料庫：
```csharp
// SQLite（預設，適合學習）
services.AddDataLayer(configuration);

// SQL Server
services.AddSqlServerDataLayer(configuration);

// PostgreSQL（需要額外套件）
services.AddPostgreSqlDataLayer(configuration);

// 記憶體資料庫（測試用）
services.AddInMemoryDataLayer();
```

## 🚀 下一步學習建議

### 階段一：理解核心概念

1. **研究 DbContext 設計**
   ```csharp
   // 查看 CioSystemDbContext.cs 中的：
   // - 實體配置方法
   // - 關係設定
   // - 索引配置
   // - 軟刪除過濾器
   ```

2. **理解 Repository 模式**
   ```csharp
   // 學習 Repository.cs 中的：
   // - 泛型設計
   // - 非同步操作
   // - 分頁查詢
   // - 條件查詢
   ```

3. **掌握 Unit of Work 模式**
   ```csharp
   // 研究 UnitOfWork.cs 中的：
   // - 交易管理
   // - 儲存庫協調
   // - 批次操作
   // - 錯誤處理
   ```

### 階段二：實作業務邏輯層

1. **創建服務介面**
   ```csharp
   // 在 CioSystem.Services 中創建：
   // - IProductService.cs
   // - IInventoryService.cs
   ```

2. **實作服務類別**
   ```csharp
   // 實作：
   // - ProductService.cs
   // - InventoryService.cs
   ```

3. **添加業務邏輯驗證**
   ```csharp
   // 實作：
   // - 資料驗證
   // - 業務規則檢查
   // - 異常處理
   ```

### 階段三：建立 API 層

1. **創建 DTO 類別**
   ```csharp
   // 在 CioSystem.API/DTOs 中創建：
   // - ProductDto.cs
   // - CreateProductDto.cs
   // - UpdateProductDto.cs
   ```

2. **實作 API 控制器**
   ```csharp
   // 在 CioSystem.API/Controllers 中創建：
   // - ProductsController.cs
   // - InventoryController.cs
   ```

3. **配置依賴注入**
   ```csharp
   // 在 Program.cs 中：
   services.AddDataLayer(configuration);
   services.AddScoped<IProductService, ProductService>();
   ```

## 🛠️ 實用工具和指令

### Entity Framework 指令
```bash
# 安裝 EF Core 工具
dotnet tool install --global dotnet-ef

# 新增遷移
dotnet ef migrations add InitialCreate --project CioSystem.Data

# 更新資料庫
dotnet ef database update --project CioSystem.Data

# 移除最後一個遷移
dotnet ef migrations remove --project CioSystem.Data
```

### 測試指令
```bash
# 建置專案
dotnet build

# 執行測試
dotnet test

# 執行 API 專案
dotnet run --project CioSystem.API
```

## 📖 學習重點

### 1. 資料庫設計原則
- **正規化**: 避免資料冗餘
- **索引**: 提高查詢效能
- **約束**: 確保資料完整性
- **關係**: 正確設定外鍵關係

### 2. Repository 模式優點
- **抽象化**: 隱藏資料存取細節
- **可測試性**: 便於單元測試
- **一致性**: 統一的資料存取介面
- **彈性**: 支援不同的資料來源

### 3. Unit of Work 模式優點
- **交易管理**: 確保資料一致性
- **效能優化**: 批次操作
- **錯誤處理**: 統一的錯誤處理機制
- **資源管理**: 自動釋放資源

### 4. 最佳實踐
- **非同步操作**: 使用 async/await
- **軟刪除**: 保留資料歷史
- **審計追蹤**: 記錄建立和修改時間
- **錯誤處理**: 適當的異常處理

## 🎓 學習檢查清單

### 基礎概念
- [ ] 理解 Entity Framework Core 的工作原理
- [ ] 掌握 DbContext 的配置方法
- [ ] 了解實體關係的設定
- [ ] 學會使用遷移管理資料庫結構

### Repository 模式
- [ ] 理解 Repository 模式的優點
- [ ] 掌握泛型 Repository 的設計
- [ ] 學會實作分頁查詢
- [ ] 了解條件查詢的使用

### Unit of Work 模式
- [ ] 理解 Unit of Work 的作用
- [ ] 掌握交易管理的方法
- [ ] 學會批次操作的實作
- [ ] 了解錯誤處理策略

### 實作技能
- [ ] 能夠建立新的實體模型
- [ ] 能夠配置實體關係
- [ ] 能夠實作新的 Repository
- [ ] 能夠使用 Unit of Work 管理交易

## 🔧 常見問題和解決方案

### Q: 如何新增新的實體？
A: 
1. 在 `CioSystem.Models` 中創建實體類別
2. 繼承 `BaseEntity`
3. 在 `CioSystemDbContext` 中添加 `DbSet`
4. 在 `OnModelCreating` 中配置實體

### Q: 如何實作新的 Repository？
A:
1. 實作 `IRepository<T>` 介面
2. 繼承 `Repository<T>` 基礎類別
3. 添加特定的業務方法
4. 在 `UnitOfWork` 中註冊

### Q: 如何處理複雜查詢？
A:
1. 使用 `IQueryable` 建立查詢
2. 使用 `Include` 載入相關資料
3. 使用 `Where` 添加條件
4. 使用 `OrderBy` 排序結果

### Q: 如何優化查詢效能？
A:
1. 使用適當的索引
2. 避免 N+1 查詢問題
3. 使用分頁查詢
4. 快取常用資料

## 🚀 下一步

現在您已經完成了資料存取層的實作！接下來可以：

1. **實作業務邏輯層**: 創建服務類別和業務邏輯
2. **建立 API 層**: 實作 RESTful API 端點
3. **開發 Web 介面**: 創建使用者介面
4. **添加測試**: 撰寫單元測試和整合測試

記住：學習資料存取層是建立現代應用程式的基礎，掌握這些概念將為您的後續學習打下堅實的基礎！