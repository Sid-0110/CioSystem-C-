@model List<CioSystem.Models.LogEntryViewModel>
@{
    ViewData["Title"] = "系統日誌";
    var statistics = ViewBag.Statistics as CioSystem.Models.LogStatisticsViewModel;
    var filter = ViewBag.Filter as CioSystem.Models.LogFilterViewModel;
    var totalCount = ViewBag.TotalCount as int? ?? 0;
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
    var pageSize = ViewBag.PageSize as int? ?? 20;
    var totalPages = ViewBag.TotalPages as int? ?? 1;
}

<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2 modern-title">
            <i class="fas fa-file-alt text-secondary"></i> 系統日誌
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i> 重新整理
                </button>
                <button type="button" class="btn btn-success" onclick="exportLogs()">
                    <i class="fas fa-download"></i> 匯出日誌
                </button>
                <button type="button" class="btn btn-warning" onclick="cleanupLogs()">
                    <i class="fas fa-trash"></i> 清理舊日誌
                </button>
                <a asp-controller="SystemSettings" asp-action="Index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> 返回
                </a>
            </div>
        </div>
    </div>

    <!-- 日誌篩選 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>日誌篩選
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <label for="logLevel" class="form-label">日誌等級</label>
                            <select id="logLevel" class="form-select">
                                <option value="">全部</option>
                                <option value="Info" selected="@(filter?.Level == "Info")">資訊</option>
                                <option value="Warning" selected="@(filter?.Level == "Warning")">警告</option>
                                <option value="Error" selected="@(filter?.Level == "Error")">錯誤</option>
                                <option value="Debug" selected="@(filter?.Level == "Debug")">除錯</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="logUser" class="form-label">用戶</label>
                            <input type="text" id="logUser" class="form-control" placeholder="輸入用戶名" value="@filter?.User" />
                        </div>
                        <div class="col-md-2">
                            <label for="logDateFrom" class="form-label">開始日期</label>
                            <input type="date" id="logDateFrom" class="form-control" value="@(filter?.StartDate?.ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-md-2">
                            <label for="logDateTo" class="form-label">結束日期</label>
                            <input type="date" id="logDateTo" class="form-control" value="@(filter?.EndDate?.ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-md-3">
                            <label for="searchKeyword" class="form-label">搜尋關鍵字</label>
                            <input type="text" id="searchKeyword" class="form-control" placeholder="搜尋訊息內容" value="@filter?.SearchKeyword" />
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="filterLogs()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" onclick="filterLogs()">
                                <i class="fas fa-search me-2"></i>篩選
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>清除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 日誌統計 -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-info-circle fa-2x text-info mb-2"></i>
                    <h5 class="card-title">資訊</h5>
                    <h3 class="text-info">@(statistics?.InfoCount ?? 0)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">警告</h5>
                    <h3 class="text-warning">@(statistics?.WarningCount ?? 0)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                    <h5 class="card-title">錯誤</h5>
                    <h3 class="text-danger">@(statistics?.ErrorCount ?? 0)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-bug fa-2x text-secondary mb-2"></i>
                    <h5 class="card-title">除錯</h5>
                    <h3 class="text-secondary">@(statistics?.DebugCount ?? 0)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-list fa-2x text-primary mb-2"></i>
                    <h5 class="card-title">總計</h5>
                    <h3 class="text-primary">@(statistics?.TotalCount ?? 0)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-user fa-2x text-success mb-2"></i>
                    <h5 class="card-title">最活躍用戶</h5>
                    <h6 class="text-success">@(statistics?.MostActiveUser ?? "無")</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- 日誌列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>日誌記錄
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>時間</th>
                                    <th>等級</th>
                                    <th>用戶</th>
                                    <th>訊息</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Any())
                                {
                                    @foreach (var log in Model)
                                    {
                                        <tr>
                                            <td>@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>
                                                <span class="badge @(log.Level == "Info" ? "bg-info" : log.Level == "Warning" ? "bg-warning" : log.Level == "Error" ? "bg-danger" : "bg-secondary")">
                                                    @log.Level
                                                </span>
                                            </td>
                                            <td>@log.User</td>
                                            <td>
                                                <span class="log-message" title="@log.Message">
                                                    @(log.Message.Length > 50 ? log.Message.Substring(0, 50) + "..." : log.Message)
                                                </span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewLogDetail(@log.Id)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="fas fa-file-alt fa-2x mb-3"></i>
                                            <br>暫無日誌記錄
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- 分頁 -->
                    @if (totalPages > 1)
                    {
                        <nav aria-label="日誌分頁">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="#" onclick="goToPage(@(currentPage - 1))" tabindex="@(currentPage == 1 ? "-1" : "")">上一頁</a>
                                </li>

                                @{
                                    int startPage = Math.Max(1, currentPage - 2);
                                    int endPage = Math.Min(totalPages, currentPage + 2);
                                }

                                @if (startPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="#" onclick="goToPage(1)">1</a>
                                    </li>
                                    @if (startPage > 2)
                                    {
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    }
                                }

                                @for (int i = startPage; i <= endPage; i++)
                                {
                                    <li class="page-item @(i == currentPage ? "active" : "")">
                                        <a class="page-link" href="#" onclick="goToPage(@i)">@i</a>
                                    </li>
                                }

                                @if (endPage < totalPages)
                                {
                                    @if (endPage < totalPages - 1)
                                    {
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    }
                                    <li class="page-item">
                                        <a class="page-link" href="#" onclick="goToPage(@totalPages)">@totalPages</a>
                                    </li>
                                }

                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <a class="page-link" href="#" onclick="goToPage(@(currentPage + 1))" tabindex="@(currentPage == totalPages ? "-1" : "")">下一頁</a>
                                </li>
                            </ul>
                        </nav>

                        <div class="text-center text-muted">
                            顯示第 @((currentPage - 1) * pageSize + 1) - @(Math.Min(currentPage * pageSize, totalCount)) 條，共 @totalCount 條記錄
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function refreshLogs() {
    location.reload();
}

function filterLogs() {
    const level = document.getElementById('logLevel').value;
    const user = document.getElementById('logUser').value;
    const dateFrom = document.getElementById('logDateFrom').value;
    const dateTo = document.getElementById('logDateTo').value;
    const searchKeyword = document.getElementById('searchKeyword').value;

    const params = new URLSearchParams();
    if (level) params.append('level', level);
    if (user) params.append('user', user);
    if (dateFrom) params.append('startDate', dateFrom);
    if (dateTo) params.append('endDate', dateTo);
    if (searchKeyword) params.append('searchKeyword', searchKeyword);
    params.append('page', '1');

    window.location.href = '@Url.Action("Index")' + '?' + params.toString();
}

function clearFilters() {
    document.getElementById('logLevel').value = '';
    document.getElementById('logUser').value = '';
    document.getElementById('logDateFrom').value = '';
    document.getElementById('logDateTo').value = '';
    document.getElementById('searchKeyword').value = '';
    filterLogs();
}

function goToPage(page) {
    const level = document.getElementById('logLevel').value;
    const user = document.getElementById('logUser').value;
    const dateFrom = document.getElementById('logDateFrom').value;
    const dateTo = document.getElementById('logDateTo').value;
    const searchKeyword = document.getElementById('searchKeyword').value;

    const params = new URLSearchParams();
    if (level) params.append('level', level);
    if (user) params.append('user', user);
    if (dateFrom) params.append('startDate', dateFrom);
    if (dateTo) params.append('endDate', dateTo);
    if (searchKeyword) params.append('searchKeyword', searchKeyword);
    params.append('page', page);

    window.location.href = '@Url.Action("Index")' + '?' + params.toString();
}

function exportLogs() {
    const level = document.getElementById('logLevel').value;
    const user = document.getElementById('logUser').value;
    const dateFrom = document.getElementById('logDateFrom').value;
    const dateTo = document.getElementById('logDateTo').value;
    const searchKeyword = document.getElementById('searchKeyword').value;

    const filter = {
        level: level || null,
        user: user || null,
        startDate: dateFrom || null,
        endDate: dateTo || null,
        searchKeyword: searchKeyword || null
    };

    fetch('@Url.Action("Export")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(filter)
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('匯出失敗');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'system_logs_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('匯出日誌時發生錯誤: ' + error.message);
    });
}

function cleanupLogs() {
    const daysToKeep = prompt('請輸入要保留的天數（預設30天）:', '30');
    if (daysToKeep === null) return;

    const days = parseInt(daysToKeep);
    if (isNaN(days) || days < 1) {
        alert('請輸入有效的天數');
        return;
    }

    if (!confirm(`確定要清理 ${days} 天前的日誌記錄嗎？此操作無法復原。`)) {
        return;
    }

    fetch('@Url.Action("Cleanup")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ daysToKeep: days })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`成功清理了 ${data.removedCount} 條舊日誌記錄`);
            location.reload();
        } else {
            alert('清理日誌時發生錯誤: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('清理日誌時發生錯誤: ' + error.message);
    });
}

function viewLogDetail(logId) {
    // 簡單的詳情顯示
    const row = event.target.closest('tr');
    const message = row.querySelector('.log-message').getAttribute('title');
    alert(`日誌詳情:\n\n${message}`);
}

// 支援Enter鍵搜尋
document.addEventListener('DOMContentLoaded', function() {
    const searchInputs = ['logUser', 'searchKeyword'];
    searchInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterLogs();
                }
            });
        }
    });
});
</script>

<style>
    .modern-title {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 600;
    }

    .card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
    }

    .log-message {
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .btn {
        transition: all 0.3s ease;
    }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
</style>